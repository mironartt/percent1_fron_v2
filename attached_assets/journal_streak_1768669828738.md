# Journal Streak — Серия записей в дневнике

**Дата:** 2026-01-17
**Версия:** 1.0

---

## Обзор

Добавлено новое поле `journal_streak` в эндпоинт `/api/rest/front/get-user-data/`. Теперь серия записей в дневнике рассчитывается на бэкенде и возвращается в ответе API.

---

## API

### Эндпоинт

`POST /api/rest/front/get-user-data/`

### Новое поле в ответе

```json
{
  "status": "ok",
  "data": {
    "id": 123,
    "email": "user@example.com",
    "has_diary_entry_today": true,
    "journal_streak": 5,
    ...
  }
}
```

| Поле | Тип | Описание |
|------|-----|----------|
| `journal_streak` | `integer` | Текущая серия записей в дневнике (дней подряд). Минимум: 0. |

---

## Логика расчёта

### Алгоритм (строгая логика)

1. Начинаем проверку с **сегодняшнего дня**
2. Если **сегодня НЕТ записи** → `journal_streak = 0`
3. Если **сегодня ЕСТЬ запись** → считаем назад до первого пропуска

### Псевдокод

```python
today = текущая_дата
streak = 0
current_date = today

while current_date имеет запись в дневнике:
    streak += 1
    current_date = current_date - 1 день

return streak
```

### Примеры

**Пример 1: Записи каждый день**
```
Сегодня (17.01): запись есть
16.01: запись есть
15.01: запись есть
14.01: записи нет
→ journal_streak = 3
```

**Пример 2: Сегодня нет записи**
```
Сегодня (17.01): записи нет
16.01: запись есть
15.01: запись есть
→ journal_streak = 0  (не продолжаем от вчера!)
```

**Пример 3: Нет записей вообще**
```
→ journal_streak = 0
```

---

## Что нужно изменить на фронтенде

### Было (локальный computed)

```javascript
// src/stores/app.js
const journalStreak = computed(() => {
  for (let i = 0; i < 365; i++) {
    const hasEntry = journal.value.entries.some(e => e.date === dateStr)
    if (hasEntry) {
      streak++
    } else if (i > 0) {  // <-- Мягкая логика: пропускали сегодня
      break
    }
  }
  return streak
})
```

### Стало (данные с бэкенда)

```javascript
// Использовать данные из get-user-data
const journalStreak = computed(() => {
  return userStore.userData?.journal_streak ?? 0
})
```

### Преимущества

1. **Единый источник правды** — бэкенд и фронтенд показывают одинаковые данные
2. **Консистентность с AI** — AI Mentor использует ту же логику
3. **Кэширование** — данные кэшируются на 10 минут, инвалидируются при добавлении записи

---

## Кэширование

| Параметр | Значение |
|----------|----------|
| TTL | 10 минут |
| Инвалидация | При создании/удалении записи в дневнике |
| Ключ кэша | `user:{user_id}:journal_streak` |

При вызове `/app/diary/update/` (создание/удаление записи) кэш автоматически сбрасывается.

---

## Миграция

### Шаги для фронтенда

1. Убрать локальный `computed` для `journalStreak`
2. Использовать `userData.journal_streak` из ответа `get-user-data`
3. Обновить все места отображения серии дневника

### Обратная совместимость

Поле добавляется в существующий ответ, ломающих изменений нет.

---

## Связанные файлы (бэкенд)

| Файл | Что изменено |
|------|--------------|
| `core/models/globals.py` | Метод `_calculate_journal_streak()`, обновлён `get_user_data()` |
| `core/serializers/user.py` | Добавлено поле `journal_streak` в `UserDataResponseSerializer` |
| `core/utils/user_cache.py` | Добавлен тип кэша `journal_streak`, инвалидация в группе `diary` |
