# Система уведомлений (Alerts)

Документация для интеграции системы уведомлений во фронтенд.

## Обзор

Система уведомлений позволяет пользователям получать напоминания и информационные сообщения через:
- **Telegram** (если бот привязан)
- **WebSocket** (через ai_bot чат в приложении)

## API эндпоинты

### Получение настроек

```
POST /api/rest/front/app/alerts/settings/get/
```

**Request:** `{}`

**Response:**
```json
{
  "status": "ok",
  "data": {
    "alerts_enabled": true,
    "timezone": "Europe/Moscow",
    "telegram_connected": true,
    "telegram_username": "@username",

    "morning_reminder_enabled": true,
    "morning_reminder_time": "08:00",
    "evening_reminder_enabled": true,
    "evening_reminder_time": "21:00",

    "streak_warning_enabled": true,
    "streak_warning_min_days": 3,
    "achievement_notification_enabled": true,
    "deadline_reminder_enabled": true,
    "deadline_reminder_days_before": 3,

    "weekly_report_enabled": true,
    "weekly_report_day": 0,
    "weekly_report_time": "10:00",

    "reward_reminder_enabled": true,
    "ssp_reevaluation_enabled": true,
    "ssp_reevaluation_day_of_month": 1,

    "inactivity_reminder_enabled": true,
    "inactivity_reminder_days": 3,
    "goal_progress_enabled": true,
    "overdue_steps_enabled": true
  }
}
```

### Обновление настроек

```
POST /api/rest/front/app/alerts/settings/update/
```

**Request:** Передавать только изменяемые поля
```json
{
  "alerts_enabled": false
}
```

или

```json
{
  "morning_reminder_enabled": true,
  "morning_reminder_time": "07:30",
  "timezone": "Europe/Moscow"
}
```

**Response:** Возвращает полные обновлённые настройки (как в GET).

## Типы уведомлений

### Ежедневные

| Поле | Тип | Описание |
|------|-----|----------|
| `morning_reminder_enabled` | bool | Утреннее напоминание |
| `morning_reminder_time` | string (HH:MM) | Время утреннего напоминания |
| `evening_reminder_enabled` | bool | Вечернее напоминание |
| `evening_reminder_time` | string (HH:MM) | Время вечернего напоминания |

### Событийные

| Поле | Тип | Описание |
|------|-----|----------|
| `streak_warning_enabled` | bool | Предупреждение о серии под угрозой |
| `streak_warning_min_days` | int (1-100) | Минимальная серия для предупреждения |
| `achievement_notification_enabled` | bool | Уведомление о достижениях |
| `deadline_reminder_enabled` | bool | Напоминание о дедлайнах целей |
| `deadline_reminder_days_before` | int (1-30) | За сколько дней напоминать |

### Еженедельные

| Поле | Тип | Описание |
|------|-----|----------|
| `weekly_report_enabled` | bool | Еженедельный отчёт |
| `weekly_report_day` | int (0-6) | День недели (0=Пн, 6=Вс) |
| `weekly_report_time` | string (HH:MM) | Время отправки |

### Дополнительные

| Поле | Тип | Описание |
|------|-----|----------|
| `reward_reminder_enabled` | bool | Напоминание о доступных наградах |
| `ssp_reevaluation_enabled` | bool | Напоминание о переоценке ССП |
| `ssp_reevaluation_day_of_month` | int (1-28) | День месяца для напоминания |

### Новые

| Поле | Тип | Описание |
|------|-----|----------|
| `inactivity_reminder_enabled` | bool | Напоминание о неактивности |
| `inactivity_reminder_days` | int (1-30) | Дней без активности для напоминания |
| `goal_progress_enabled` | bool | Уведомление о прогрессе целей (80%+) |
| `overdue_steps_enabled` | bool | Уведомление о просроченных шагах |

## Глобальные настройки

| Поле | Тип | Описание |
|------|-----|----------|
| `alerts_enabled` | bool | Глобальный переключатель всех уведомлений |
| `timezone` | string | Часовой пояс (напр. "Europe/Moscow") |
| `telegram_connected` | bool | Привязан ли Telegram бот (read-only) |
| `telegram_username` | string | Username в Telegram (read-only) |

## Часовые пояса

Популярные значения:
- `Europe/Moscow` (по умолчанию)
- `Europe/Kiev`
- `Europe/Minsk`
- `Asia/Almaty`
- `Asia/Yekaterinburg`
- `Asia/Novosibirsk`
- `Asia/Vladivostok`

Полный список: [IANA Time Zone Database](https://www.iana.org/time-zones)

## Дни недели

Для `weekly_report_day`:
- `0` = Понедельник
- `1` = Вторник
- `2` = Среда
- `3` = Четверг
- `4` = Пятница
- `5` = Суббота
- `6` = Воскресенье

## Интерфейс настроек

### Рекомендуемая структура UI

```
Уведомления
├── [toggle] Все уведомления включены
├── Telegram: @username (привязан) или "Привязать бота"
├── Часовой пояс: [select]
│
├── Ежедневные
│   ├── [toggle] Утреннее напоминание [time: 08:00]
│   └── [toggle] Вечернее напоминание [time: 21:00]
│
├── Серии и достижения
│   ├── [toggle] Предупреждение о серии [min: 3 дней]
│   ├── [toggle] Новые достижения
│   └── [toggle] Дедлайны целей [за 3 дней]
│
├── Еженедельный отчёт
│   └── [toggle] Отчёт за неделю [день: Пн] [время: 10:00]
│
├── Дополнительные
│   ├── [toggle] Напоминание о наградах
│   ├── [toggle] Переоценка ССП [день месяца: 1]
│   ├── [toggle] Неактивность [дней: 3]
│   ├── [toggle] Прогресс целей (80%+)
│   └── [toggle] Просроченные шаги
```

### Валидация на клиенте

```javascript
// Время в формате HH:MM
const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/;

// Проверка timezone
const validTimezones = ['Europe/Moscow', 'Europe/Kiev', ...];

// Числовые ограничения
streak_warning_min_days: 1-100
deadline_reminder_days_before: 1-30
ssp_reevaluation_day_of_month: 1-28
inactivity_reminder_days: 1-30
weekly_report_day: 0-6
```

## Доставка уведомлений

### Telegram
Если `telegram_connected: true`, уведомления отправляются в личный чат с ботом OnePercent.

### WebSocket
Уведомления приходят через существующий WebSocket канал ai_bot чата. Сообщение будет отображаться как сообщение от бота в чате.

## Примеры использования

### Получить настройки при загрузке страницы

```javascript
const response = await api.post('/app/alerts/settings/get/');
if (response.status === 'ok') {
  alertSettings.value = response.data;
}
```

### Обновить отдельную настройку

```javascript
async function toggleMorningReminder(enabled) {
  const response = await api.post('/app/alerts/settings/update/', {
    morning_reminder_enabled: enabled
  });
  if (response.status === 'ok') {
    alertSettings.value = response.data;
  }
}
```

### Обновить время напоминания

```javascript
async function updateMorningTime(time) {
  const response = await api.post('/app/alerts/settings/update/', {
    morning_reminder_time: time  // "08:30"
  });
  if (response.status === 'ok') {
    alertSettings.value = response.data;
  }
}
```

### Отключить все уведомления

```javascript
async function disableAllAlerts() {
  const response = await api.post('/app/alerts/settings/update/', {
    alerts_enabled: false
  });
  if (response.status === 'ok') {
    alertSettings.value = response.data;
  }
}
```

## Коды ошибок

| Код | Описание |
|-----|----------|
| `invalid_timezone` | Некорректный часовой пояс |
| `validation_error` | Ошибка валидации полей |

## Связанные системы

- **Telegram Bot**: Для получения уведомлений в Telegram пользователь должен привязать бота через `/start` команду
- **AI Chat**: WebSocket уведомления отображаются в ai_bot беседе
- **Celery**: Dispatcher'ы проверяют настройки каждые 5 минут с учётом часового пояса пользователя
