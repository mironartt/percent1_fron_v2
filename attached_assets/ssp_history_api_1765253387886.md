# API документация: История переоценок ССП

## Обзор изменений

Бэкенд обновлён для поддержки истории переоценок ССП. Теперь каждая переоценка сохраняется отдельно и доступна в табе "История".

## Основные концепции

### ssp_evaluation_id

Это UUID, который группирует 6 сфер одной переоценки.

**Логика работы:**
- Если `ssp_evaluation_id` **передан** в запросе → редактируем существующую переоценку
- Если `ssp_evaluation_id` **НЕ передан** → создаём новую переоценку с новым UUID

## Эндпоинты

### 1. Получение данных ССП

**URL:** `POST /api/rest/front/app/ssp/get/`

**Request:** Пустой (EmptySerializer)

**Response:**
```json
{
  "status": "ok",
  "data": {
    "ssp_evaluation_id": "550e8400-e29b-41d4-a716-446655440000",  // NEW! ID текущей переоценки
    "max_rating": 10,
    "base_categories_info": [...],
    "circle_data": [...],
    "categories_reflection_data": [...],
    "total_data": {...}
  }
}
```

**Важно:**
- Возвращает последнюю переоценку пользователя
- `ssp_evaluation_id` нужно сохранить для последующего редактирования

---

### 2. Обновление/создание данных ССП

**URL:** `POST /api/rest/front/app/ssp/update/`

**Request:**
```json
{
  "ssp_evaluation_id": "550e8400-e29b-41d4-a716-446655440000",  // NEW! Опциональный параметр
  "categories_reflection_data": [
    {
      "category": "health_sport",
      "rating": 8,
      "rating_reason": "Регулярно тренируюсь",
      "what_mean_max_rating": "Идеальное здоровье и форма",
      "max_rating_difficulties": "Нехватка времени",
      "what_want": "Улучшить режим сна"
    },
    // ... остальные 5 категорий
  ]
}
```

**Response:** Такой же, как в `GET /app/ssp/get/` — возвращает обновлённые данные

**Логика:**

**Режим 1: Редактирование существующей переоценки**
```javascript
// Когда пользователь редактирует текущую оценку
const response = await api.post('/app/ssp/update/', {
  ssp_evaluation_id: currentEvaluationId,  // Передаём существующий ID
  categories_reflection_data: [...]
});
```

**Режим 2: Создание новой переоценки**
```javascript
// Когда пользователь нажимает "Переоценить"
const response = await api.post('/app/ssp/update/', {
  // ssp_evaluation_id НЕ передаём!
  categories_reflection_data: [...]
});
```

---

### 3. Получение истории переоценок

**URL:** `POST /api/rest/front/app/ssp/history/get/`

**Request:** Пустой (EmptySerializer)

**Response:**
```json
{
  "status": "ok",
  "data": {
    "has_data": true,  // false, если нет данных истории

    // Полная история всех переоценок
    "history": [
      {
        "ssp_evaluation_id": "550e8400-e29b-41d4-a716-446655440000",
        "date": "2024-12-09T12:00:00+03:00",
        "average": 6.5,  // Средний балл по всем сферам
        "spheres": [
          {"id": "health_sport", "score": 7},
          {"id": "welfare", "score": 6},
          {"id": "hobby", "score": 5},
          {"id": "environment", "score": 8},
          {"id": "work", "score": 7},
          {"id": "family", "score": 6}
        ]
      },
      // ... остальные переоценки (от старых к новым)
    ],

    // Данные для графика (последние 10 оценок)
    "chart_data": [
      {"date": "2024-12-01T12:00:00+03:00", "average": 5.8},
      {"date": "2024-12-05T12:00:00+03:00", "average": 6.2},
      {"date": "2024-12-09T12:00:00+03:00", "average": 6.5}
      // ... до 10 записей
    ],

    // Тренды по сферам (сравнение последней и предпоследней оценки)
    "spheres_trends": [
      {
        "id": "health_sport",
        "title": "Здоровье и спорт",
        "current_score": 7,
        "previous_score": 5,
        "trend": "up",  // "up" | "down" | "stable"
        "change": 2  // Разница между current и previous
      },
      {
        "id": "welfare",
        "title": "Благосостояние",
        "current_score": 6,
        "previous_score": 6,
        "trend": "stable",
        "change": 0
      },
      // ... остальные сферы
    ]
  }
}
```

**Пустое состояние (нет данных):**
```json
{
  "status": "ok",
  "data": {
    "has_data": false,
    "history": [],
    "chart_data": [],
    "spheres_trends": []
  }
}
```

## Сценарии использования

### Сценарий 1: Первая оценка пользователя

```javascript
// 1. Пользователь впервые заполняет ССП
const response = await api.post('/app/ssp/update/', {
  // ssp_evaluation_id НЕ передаём
  categories_reflection_data: [...]
});

// 2. Сохраняем полученный ID для дальнейшего редактирования
const evaluationId = response.data.ssp_evaluation_id;
localStorage.setItem('current_ssp_evaluation_id', evaluationId);
```

### Сценарий 2: Редактирование текущей оценки

```javascript
// Пользователь редактирует текущую оценку
const currentId = localStorage.getItem('current_ssp_evaluation_id');

const response = await api.post('/app/ssp/update/', {
  ssp_evaluation_id: currentId,  // Передаём ID
  categories_reflection_data: [...]
});
```

### Сценарий 3: Переоценка (создание новой)

```javascript
// Пользователь нажимает кнопку "Переоценить"
const response = await api.post('/app/ssp/update/', {
  // ssp_evaluation_id НЕ передаём → создастся новая запись
  categories_reflection_data: [...]
});

// Сохраняем новый ID
const newEvaluationId = response.data.ssp_evaluation_id;
localStorage.setItem('current_ssp_evaluation_id', newEvaluationId);
```

### Сценарий 4: Отображение таба "История"

```javascript
// Загружаем данные истории
const response = await api.post('/app/ssp/history/get/');

if (response.data.has_data) {
  // Отображаем график
  renderChart(response.data.chart_data);

  // Отображаем тренды по сферам
  renderTrends(response.data.spheres_trends);

  // Полная история доступна в response.data.history
} else {
  // Показываем пустое состояние
  showEmptyState();
}
```

## Важные моменты

1. **ID текущей оценки:**
   - Получайте `ssp_evaluation_id` из ответа `/app/ssp/get/`
   - Сохраняйте его в localStorage/Vuex для редактирования
   - При переоценке — НЕ передавайте ID

2. **Определение режима:**
   ```javascript
   const isNewEvaluation = !currentEvaluationId;  // Новая переоценка
   const isEditing = !!currentEvaluationId;       // Редактирование
   ```

3. **Обратная совместимость:**
   - Старые записи без `ssp_evaluation_id` будут работать
   - При первом запросе `/app/ssp/get/` получат UUID

4. **История:**
   - Пустое состояние: `has_data: false`
   - Тренды рассчитываются только при наличии 2+ переоценок
   - При одной оценке: `trend: "stable"` для всех сфер

## Пример интеграции

```javascript
// store/modules/ssp.js
export default {
  state: {
    currentEvaluationId: null,
    sspData: null,
    history: null,
  },

  actions: {
    // Загрузить текущие данные ССП
    async loadSSP({ commit }) {
      const response = await api.post('/app/ssp/get/');
      commit('SET_SSP_DATA', response.data);
      commit('SET_EVALUATION_ID', response.data.ssp_evaluation_id);
    },

    // Сохранить изменения (редактирование)
    async saveSSP({ state, commit }, categoriesData) {
      const response = await api.post('/app/ssp/update/', {
        ssp_evaluation_id: state.currentEvaluationId,  // Передаём ID
        categories_reflection_data: categoriesData,
      });
      commit('SET_SSP_DATA', response.data);
    },

    // Создать новую переоценку
    async createNewEvaluation({ commit }, categoriesData) {
      const response = await api.post('/app/ssp/update/', {
        // ssp_evaluation_id НЕ передаём
        categories_reflection_data: categoriesData,
      });
      commit('SET_SSP_DATA', response.data);
      commit('SET_EVALUATION_ID', response.data.ssp_evaluation_id);
    },

    // Загрузить историю
    async loadHistory({ commit }) {
      const response = await api.post('/app/ssp/history/get/');
      commit('SET_HISTORY', response.data);
    },
  },
};
```

## Миграция существующего кода

**Что нужно изменить:**

1. Добавить обработку `ssp_evaluation_id` в ответах
2. Разделить логику "сохранить изменения" и "создать переоценку"
3. Добавить таб "История" с запросом к `/app/ssp/history/get/`

**Минимальные изменения:**

Если не хотите пока добавлять переоценки, ничего менять не нужно — старый код будет работать:

```javascript
// Старый код продолжит работать
await api.post('/app/ssp/update/', {
  categories_reflection_data: [...]
  // ssp_evaluation_id можно не передавать
});
```

Новое поле `ssp_evaluation_id` в ответе просто игнорируется, если не используется.