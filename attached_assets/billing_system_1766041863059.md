# API документация: Тарифная система и биллинг

## Обзор

Система тарифов и оплаты OnePercent включает:
- 3 уровня тарифов: Free (бесплатный), Basic, Pro
- 7-дневный триал с полным доступом (Pro) после регистрации
- Периоды подписки: 1, 3, 6, 12 месяцев со скидками
- Промокоды с процентными или фиксированными скидками
- Интеграция с Robokassa для приема платежей
- Перерасчет при смене тарифа (upgrade/downgrade)

## Основные концепции

### Тарифы

| Тариф | Цена/мес | Лимиты | Функции |
|-------|----------|--------|---------|
| Free | 0 р. | 3 цели, 5 привычек, 10 записей дневника/мес | Базовый функционал |
| Basic | 299 р. | Безлимитно | goals_unlimited, habits_unlimited, diary_unlimited, ssp_history |
| Pro | 599 р. | Безлимитно | Все из Basic + goals_ai_assistant, habits_analytics, chat_ai, priority_support |

### Периоды подписки (Terms)

| ID | Период | Скидка | is_hit |
|----|--------|--------|--------|
| 1 | 1 месяц | 0% | false |
| 3 | 3 месяца | 10% | true |
| 6 | 6 месяцев | 15% | false |
| 12 | 12 месяцев | 20% | false |

### Статусы подписки

- `trial` - активный триал (7 дней после регистрации, полный доступ Pro)
- `active` - активная подписка (платная или free после триала)
- `expired` - истекшая подписка (переход на free)

### Промокоды

Промокоды используют parent/child структуру:
- **Master промокод**: `code='SUMMER2024', user=NULL` - шаблон
- **Child промокод**: `code='SUMMER2024', user=123` - привязан к пользователю после активации

При активации создается child от master. После оплаты child помечается как использованный.

---

## Эндпоинты

### 0. Публичное получение тарифов (для лендинга)

**URL:** `POST /api/rest/front/land/tariffs/get/`

**Авторизация:** Не требуется

**Request:**
```json
{}
```

**Response:** Аналогичен `/app/tariffs/get/`, но цены без учёта промокода.

**Использование:**
- На лендинге для отображения тарифов неавторизованным пользователям
- Цены возвращаются базовые (без скидок по промокоду)

---

### 1. Получение списка тарифов

**URL:** `POST /api/rest/front/app/tariffs/get/`

**Request:**
```json
{}
```

**Response:**
```json
{
  "status": "ok",
  "data": {
    "tariffs": [
      {
        "id": 1,
        "code": "free",
        "title": "Бесплатный",
        "description": "Базовый функционал для начала работы",
        "price": 0.00,
        "features": [],
        "limits": {
          "max_goals": 3,
          "max_habits": 5,
          "max_diary_entries_per_month": 10
        },
        "terms": []
      },
      {
        "id": 2,
        "code": "basic",
        "title": "Базовый",
        "description": "Расширенный функционал для активного развития",
        "price": 299.00,
        "features": ["goals_unlimited", "habits_unlimited", "diary_unlimited", "ssp_history"],
        "limits": null,
        "terms": [
          {
            "id": 1,
            "months": 1,
            "title": "1 месяц",
            "discount": 0,
            "is_hit": false,
            "base_price": 299.00,
            "total_price": 299.00,
            "term_discount_value": 0.00,
            "promocode_discount": 0,
            "promocode_discount_value": 0.00,
            "final_price": 299.00,
            "expired_date": "2025-01-18"
          },
          {
            "id": 3,
            "months": 3,
            "title": "3 месяца",
            "discount": 10,
            "is_hit": true,
            "base_price": 299.00,
            "total_price": 897.00,
            "term_discount_value": 89.00,
            "promocode_discount": 0,
            "promocode_discount_value": 0.00,
            "final_price": 808.00,
            "expired_date": "2025-03-18"
          },
          {
            "id": 6,
            "months": 6,
            "title": "6 месяцев",
            "discount": 15,
            "is_hit": false,
            "base_price": 299.00,
            "total_price": 1794.00,
            "term_discount_value": 269.00,
            "promocode_discount": 0,
            "promocode_discount_value": 0.00,
            "final_price": 1525.00,
            "expired_date": "2025-06-18"
          },
          {
            "id": 12,
            "months": 12,
            "title": "12 месяцев",
            "discount": 20,
            "is_hit": false,
            "base_price": 299.00,
            "total_price": 3588.00,
            "term_discount_value": 717.00,
            "promocode_discount": 0,
            "promocode_discount_value": 0.00,
            "final_price": 2871.00,
            "expired_date": "2025-12-18"
          }
        ]
      },
      {
        "id": 3,
        "code": "pro",
        "title": "Профессиональный",
        "description": "Полный функционал с AI-помощником и приоритетной поддержкой",
        "price": 599.00,
        "features": [
          "goals_unlimited", "goals_ai_assistant", "habits_unlimited",
          "habits_analytics", "diary_unlimited", "ssp_history",
          "chat_ai", "priority_support"
        ],
        "limits": null,
        "terms": [...]
      }
    ],
    "terms": [
      {"id": 1, "months": 1, "title": "1 месяц", "discount": 0, "is_hit": false},
      {"id": 3, "months": 3, "title": "3 месяца", "discount": 10, "is_hit": true},
      {"id": 6, "months": 6, "title": "6 месяцев", "discount": 15, "is_hit": false},
      {"id": 12, "months": 12, "title": "12 месяцев", "discount": 20, "is_hit": false}
    ]
  }
}
```

**Важно:**
- Цены в `terms` уже учитывают активный промокод пользователя (если есть)
- `is_hit: true` - рекомендуемый период (для UI выделения)
- Free тариф не имеет `terms` (бесплатный)
- `limits: null` означает безлимитный доступ

---

### 2. Получение подписки пользователя

**URL:** `POST /api/rest/front/app/subscription/get/`

**Request:**
```json
{}
```

**Response:**
```json
{
  "status": "ok",
  "data": {
    "subscription": {
      "status": "trial",
      "tariff": {
        "id": 3,
        "code": "pro",
        "title": "Профессиональный"
      },
      "effective_status": "trial",
      "effective_tariff": {
        "id": 3,
        "code": "pro",
        "title": "Профессиональный"
      },
      "is_trial": true,
      "is_trial_expired": false,
      "trial_end": "2025-01-25T00:00:00Z",
      "is_paid": false,
      "paid_end": null,
      "days_remaining": 7,
      "can_upgrade": false,
      "can_prolong": false
    },
    "active_promocode": null
  }
}
```

**Важно: Поля effective_***

API возвращает два набора данных:
- `status`, `tariff` — сырые данные из БД (для отладки и истории)
- `effective_status`, `effective_tariff` — **реальное состояние** с учётом истечения триала

**Для UI всегда используйте `effective_*` поля!**

Это нужно потому что после истечения триала:
- `status` остаётся `"trial"` в БД
- `effective_status` становится `"expired"`
- `tariff` остаётся Pro в БД
- `effective_tariff` становится Free

**Примеры статусов:**

**Активный триал:**
```json
{
  "status": "trial",
  "tariff": {"code": "pro", "title": "Профессиональный"},
  "effective_status": "trial",
  "effective_tariff": {"code": "pro", "title": "Профессиональный"},
  "is_trial": true,
  "is_trial_expired": false,
  "trial_end": "2025-01-25T00:00:00Z",
  "is_paid": false,
  "days_remaining": 5,
  "can_upgrade": false,
  "can_prolong": false
}
```

**Истёкший триал (важный кейс!):**
```json
{
  "status": "trial",
  "tariff": {"code": "pro", "title": "Профессиональный"},
  "effective_status": "expired",
  "effective_tariff": {"code": "free", "title": "Бесплатный"},
  "is_trial": false,
  "is_trial_expired": true,
  "trial_end": "2025-01-15T00:00:00Z",
  "is_paid": false,
  "days_remaining": 0,
  "can_upgrade": true,
  "can_prolong": false
}
```

**Активная платная подписка:**
```json
{
  "status": "active",
  "tariff": {"code": "basic", "title": "Базовый"},
  "effective_status": "active",
  "effective_tariff": {"code": "basic", "title": "Базовый"},
  "is_trial": false,
  "is_trial_expired": false,
  "is_paid": true,
  "paid_end": "2025-04-18T00:00:00Z",
  "days_remaining": 90,
  "can_upgrade": true,
  "can_prolong": true
}
```

**Бесплатный тариф:**
```json
{
  "status": "active",
  "tariff": {"code": "free", "title": "Бесплатный"},
  "effective_status": "active",
  "effective_tariff": {"code": "free", "title": "Бесплатный"},
  "is_trial": false,
  "is_trial_expired": false,
  "is_paid": false,
  "days_remaining": 0,
  "can_upgrade": true,
  "can_prolong": false
}
```

---

### 3. Активация промокода

**URL:** `POST /api/rest/front/app/promocode/activate/`

**Request:**
```json
{
  "code": "WELCOME20"
}
```

**Response (успех):**
```json
{
  "status": "ok",
  "data": {
    "promocode": {
      "id": 15,
      "code": "WELCOME20",
      "discount_type": "percent",
      "discount_value": 20.0,
      "valid_until": "2025-12-31T23:59:59Z",
      "is_valid": true
    }
  }
}
```

**Response (ошибка):**
```json
{
  "status": "error",
  "error_code": "TARIFF003_promocode_invalid",
  "error_message": "Промокод недействителен"
}
```

**Возможные ошибки:**
- `promocode_invalid` - промокод не найден или недействителен
- `promocode_exhausted` - промокод исчерпан (достигнут max_uses)
- `promocode_already_activated` - промокод уже активирован этим пользователем

**Важно:**
- После активации промокод действует до первой успешной оплаты
- Промокод автоматически применяется к расчету цен в `/app/tariffs/get/`

---

### 4. Получение активного промокода

**URL:** `POST /api/rest/front/app/promocode/get/`

**Request:**
```json
{}
```

**Response:**
```json
{
  "status": "ok",
  "data": {
    "promocode": {
      "id": 15,
      "code": "WELCOME20",
      "discount_type": "percent",
      "discount_value": 20.0,
      "valid_until": "2025-12-31T23:59:59Z",
      "is_valid": true
    }
  }
}
```

Если промокода нет:
```json
{
  "status": "ok",
  "data": {
    "promocode": null
  }
}
```

---

### 5. Расчет стоимости тарифа

**URL:** `POST /api/rest/front/app/payment/calculate/`

**Request:**
```json
{
  "tariff_id": 2,
  "term_id": 3
}
```

**Response:**
```json
{
  "status": "ok",
  "data": {
    "calculation": {
      "tariff_id": 2,
      "tariff_title": "Базовый",
      "term_id": 3,
      "term_months": 3,

      "base_price": 299.00,
      "total_price": 897.00,
      "term_discount": 10,
      "term_discount_value": 89.00,

      "promocode_discount": 20,
      "promocode_discount_value": 161.00,

      "unused_days_value": 0.00,
      "bonus_days": 0,

      "final_price": 647.00,
      "date_finished": "2025-04-18T00:00:00Z",
      "is_prolong": false
    }
  }
}
```

**Поля:**
- `base_price` - базовая цена тарифа за месяц
- `total_price` - полная стоимость за период (base_price * months)
- `term_discount` / `term_discount_value` - скидка за период (10-20%)
- `promocode_discount` / `promocode_discount_value` - скидка по промокоду
- `unused_days_value` - стоимость неиспользованных дней текущей подписки (при смене тарифа)
- `bonus_days` - бонусные дни (если unused_days_value > final_price)
- `final_price` - итоговая сумма к оплате
- `date_finished` - дата окончания подписки после оплаты
- `is_prolong` - true если это продление текущего тарифа

**Пример перерасчета при смене тарифа:**

Пользователь с Basic (осталось 60 дней, заплачено 808р за 3 мес) переходит на Pro:

```json
{
  "calculation": {
    "tariff_title": "Профессиональный",
    "term_months": 1,
    "base_price": 599.00,
    "total_price": 599.00,
    "unused_days_value": 269.00,
    "final_price": 330.00,
    "is_prolong": false
  }
}
```

---

### 6. Создание платежа

**URL:** `POST /api/rest/front/app/payment/create/`

**Request:**
```json
{
  "tariff_id": 2,
  "term_id": 3,
  "final_price": 647.00
}
```

**Response:**
```json
{
  "status": "ok",
  "data": {
    "payment_id": 123,
    "payment_link": "https://auth.robokassa.ru/Merchant/Index.aspx?MerchantLogin=..."
  }
}
```

**Важно:**
- `final_price` должен точно совпадать с результатом `/payment/calculate/`
- При несовпадении вернется ошибка `price_mismatch`
- После получения `payment_link` нужно перенаправить пользователя на эту ссылку

**Возможные ошибки:**
- `invalid_tariff_id` - тариф не найден или неактивен
- `invalid_term_id` - недопустимый период
- `cannot_buy_free_tariff` - нельзя купить бесплатный тариф
- `price_mismatch` - сумма не совпадает с расчетом

---

### 7. История платежей

**URL:** `POST /api/rest/front/app/payment/history/`

**Request:**
```json
{}
```

**Response:**
```json
{
  "status": "ok",
  "data": {
    "payments": [
      {
        "id": 123,
        "date": "2025-01-15T10:30:00Z",
        "tariff": "Базовый",
        "term_months": 3,
        "amount": 647.00,
        "status": "done"
      },
      {
        "id": 100,
        "date": "2024-10-15T14:20:00Z",
        "tariff": "Профессиональный",
        "term_months": 1,
        "amount": 599.00,
        "status": "done"
      }
    ]
  }
}
```

---

## Callback URLs (Robokassa)

После оплаты Robokassa отправляет callbacks и редиректы:

### Result URL (server-to-server)

**URL:** `POST/GET /payment/result/`

Robokassa вызывает после успешной оплаты. Сервер проверяет подпись и активирует подписку.

### Success URL (redirect)

**URL:** `GET /payment/success/?payment_id={id}`

Пользователь перенаправляется после успешной оплаты.
Редирект на: `/billing/success?payment_id={id}`

### Fail URL (redirect)

**URL:** `GET /payment/fail/?payment_id={id}`

Пользователь перенаправляется при отмене или ошибке оплаты.
Редирект на: `/billing/fail?payment_id={id}`

---

## Типовые сценарии

### Сценарий 1: Загрузка страницы тарифов

```javascript
// 1. Получить данные подписки
const subscription = await api.post('/app/subscription/get/');

// 2. Получить список тарифов (цены уже с учетом промокода)
const tariffs = await api.post('/app/tariffs/get/');

// Отобразить:
// - Текущий статус подписки (subscription.data.subscription)
// - Активный промокод (subscription.data.active_promocode)
// - Список тарифов с ценами (tariffs.data.tariffs)
```

### Сценарий 2: Активация промокода

```javascript
// 1. Активировать промокод
try {
  const result = await api.post('/app/promocode/activate/', {
    code: 'WELCOME20'
  });

  showSuccess(`Промокод ${result.data.promocode.code} активирован!`);

  // 2. Перезагрузить тарифы (цены обновятся)
  const tariffs = await api.post('/app/tariffs/get/');

} catch (error) {
  showError(error.error_message);
}
```

### Сценарий 3: Покупка тарифа

```javascript
// 1. Пользователь выбрал тариф и период
const tariffId = 2;  // Basic
const termId = 3;    // 3 месяца

// 2. Расчет стоимости (показать пользователю)
const calculation = await api.post('/app/payment/calculate/', {
  tariff_id: tariffId,
  term_id: termId
});

// 3. Показать модалку с деталями
showPaymentModal({
  tariff: calculation.data.calculation.tariff_title,
  period: `${calculation.data.calculation.term_months} мес.`,
  basePrice: calculation.data.calculation.total_price,
  discount: calculation.data.calculation.term_discount_value +
            calculation.data.calculation.promocode_discount_value,
  finalPrice: calculation.data.calculation.final_price,
  dateFinished: calculation.data.calculation.date_finished
});

// 4. Пользователь подтверждает - создаем платеж
const payment = await api.post('/app/payment/create/', {
  tariff_id: tariffId,
  term_id: termId,
  final_price: calculation.data.calculation.final_price
});

// 5. Редирект на Robokassa
window.location.href = payment.data.payment_link;
```

### Сценарий 4: Обработка успешной оплаты

```javascript
// На странице /billing/success
const urlParams = new URLSearchParams(window.location.search);
const paymentId = urlParams.get('payment_id');

// Показать сообщение об успехе
showSuccess('Оплата прошла успешно!');

// Обновить данные подписки
const subscription = await api.post('/app/subscription/get/');

// Перенаправить в приложение
router.push('/app');
```

### Сценарий 5: Проверка доступа к функции

```javascript
// ВАЖНО: Используйте effective_tariff вместо tariff!
const subscription = store.getSubscription();

function hasFeature(featureId) {
  // Используем effective_tariff - он уже учитывает истечение триала
  const tariffCode = subscription.effective_tariff.code;

  // Free тариф - проверяем базовые функции
  if (tariffCode === 'free') {
    return false; // Free не имеет premium функций
  }

  // Basic тариф
  if (tariffCode === 'basic') {
    return ['goals_unlimited', 'habits_unlimited',
            'diary_unlimited', 'ssp_history'].includes(featureId);
  }

  // Pro тариф (включая активный триал)
  if (tariffCode === 'pro') {
    return ['goals_unlimited', 'goals_ai_assistant', 'habits_unlimited',
            'habits_analytics', 'diary_unlimited', 'ssp_history',
            'chat_ai', 'priority_support'].includes(featureId);
  }

  return false;
}

// Использование
if (hasFeature('chat_ai')) {
  showAIChatButton();
}
```

**Важно:** Всегда используйте `effective_tariff` вместо `tariff`! Поле `tariff` содержит данные из БД и может показывать Pro даже после истечения триала.

---

## Бизнес-логика

### Расчет итоговой цены

```
1. total_price = base_price * months
2. term_discount_value = floor(total_price * term_discount / 100)
3. price_after_term = total_price - term_discount_value
4. promocode_discount_value = floor(price_after_term * promocode_discount / 100)
5. final_price = price_after_term - promocode_discount_value - unused_days_value
6. Если final_price < 0: bonus_days = |final_price| / day_price, final_price = 0
```

### Перерасчет при смене тарифа

При переходе с платного тарифа на другой:

1. Рассчитывается стоимость неиспользованных дней:
   ```
   remaining_days = date_finished - now
   total_days = date_finished - date_started
   unused_value = last_payment_amount * remaining_days / total_days
   ```

2. Вычитается из стоимости нового тарифа

3. Если unused_value > new_price - начисляются бонусные дни

### Триал

- Длительность: 7 дней (настройка TRIAL_DAYS)
- Доступ: полный Pro функционал
- После окончания: автоматический переход на Free
- Триал можно использовать только 1 раз

---

## Проверка лимитов

Для бесплатного тарифа (после триала) действуют лимиты:

```javascript
// ВАЖНО: Используйте effective_tariff.code для проверки лимитов!
const subscription = store.getSubscription();
const tariffCode = subscription.effective_tariff.code;

// Перед созданием цели
const goalsCount = await getGoalsCount();
if (tariffCode === 'free' && goalsCount >= 3) {
  showUpgradeModal('Достигнут лимит целей. Перейдите на платный тариф.');
  return;
}

// Перед созданием привычки
const habitsCount = await getHabitsCount();
if (tariffCode === 'free' && habitsCount >= 5) {
  showUpgradeModal('Достигнут лимит привычек. Перейдите на платный тариф.');
  return;
}

// Для дневника - проверка за текущий месяц
const diaryEntriesThisMonth = await getDiaryEntriesThisMonth();
if (tariffCode === 'free' && diaryEntriesThisMonth >= 10) {
  showUpgradeModal('Достигнут лимит записей дневника в этом месяце.');
  return;
}
```

---

## Обработка ошибок

### Стандартные ошибки API

```json
{
  "status": "error",
  "error_code": "TARIFF00X_error_type",
  "error_message": "Описание ошибки"
}
```

### Коды ошибок

| Код | Описание |
|-----|----------|
| `promocode_invalid` | Промокод не найден или недействителен |
| `promocode_exhausted` | Промокод исчерпан |
| `invalid_tariff_id` | Тариф не найден |
| `invalid_term_id` | Недопустимый период |
| `cannot_buy_free_tariff` | Нельзя купить бесплатный тариф |
| `price_mismatch` | Сумма не совпадает с расчетом |

---

## Чек-лист интеграции фронтенда

1. [ ] Страница тарифов:
   - [ ] Отображение 3 тарифов с ценами по периодам
   - [ ] Выделение рекомендуемого периода (is_hit)
   - [ ] Поле ввода промокода
   - [ ] Кнопка "Оплатить" → расчет → подтверждение → Robokassa

2. [ ] Страница подписки (профиль):
   - [ ] Текущий тариф и статус
   - [ ] Дата окончания (trial_end или paid_end)
   - [ ] Оставшиеся дни
   - [ ] Активный промокод
   - [ ] Кнопки "Улучшить" / "Продлить"

3. [ ] История платежей:
   - [ ] Список платежей с датами и суммами
   - [ ] Статус платежей

4. [ ] Страницы callback:
   - [ ] `/billing/success` - успешная оплата
   - [ ] `/billing/fail` - неуспешная оплата

5. [ ] Проверка доступа:
   - [ ] Функция `hasFeature(featureId)`
   - [ ] Проверка лимитов перед созданием объектов
   - [ ] Показ модалки upgrade при превышении лимитов

6. [ ] UI блокировки:
   - [ ] Скрытие AI-кнопок для Free тарифа
   - [ ] Блокировка создания сверх лимитов
   - [ ] Бейдж "Pro" для premium функций

---

## Примечания

1. **Цены в рублях** - все суммы в рублях с 2 знаками после запятой

2. **Даты в ISO 8601** - все даты в формате `2025-01-18T00:00:00Z`

3. **Промокод применяется автоматически** - после активации скидка отображается в `/app/tariffs/get/`

4. **final_price должен совпадать** - при создании платежа сумма сверяется с расчетом

5. **Триал доступен 1 раз** - после использования `is_trial_used = True`

6. **Перерасчет работает в обе стороны** - и при upgrade, и при downgrade

7. **Бонусные дни** - если при перерасчете unused_value > new_price, разница конвертируется в дни
