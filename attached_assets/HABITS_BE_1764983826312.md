# –†–∞–∑–¥–µ–ª "–ü—Ä–∏–≤—ã—á–∫–∏" ‚Äî –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –±—ç–∫–µ–Ω–¥–∞

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û–±–∑–æ—Ä –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã](#–æ–±–∑–æ—Ä-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã)
2. [–ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö](#–º–æ–¥–µ–ª–∏-–¥–∞–Ω–Ω—ã—Ö)
3. [API Endpoints](#api-endpoints)
4. [–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞](#–±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞)
5. [–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º](#–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è-—Å-—Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º)
6. [–ú–∏–≥—Ä–∞—Ü–∏–∏ –∏ –¥–µ–ø–ª–æ–π](#–º–∏–≥—Ä–∞—Ü–∏–∏-–∏-–¥–µ–ø–ª–æ–π)

---

## –û–±–∑–æ—Ä –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

### –ü—Ä–∏–Ω—Ü–∏–ø –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–ª–µ–¥—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º –ø—Ä–æ–µ–∫—Ç–∞:

| –°–ª–æ–π | –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ | –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å |
|------|--------------|-----------------|
| **–ú–æ–¥–µ–ª–∏** | `core/models/user_data.py` | –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö, –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã |
| **–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞** | `core/models/globals.py` (–∫–ª–∞—Å—Å `User`) | –ú–µ—Ç–æ–¥—ã `get_*`, `update_*` |
| **Endpoints** | `core/views/drf/front_api_methods/habits.py` | –¢–æ–Ω–∫–∏–µ –æ–±—ë—Ä—Ç–∫–∏ –Ω–∞–¥ –ª–æ–≥–∏–∫–æ–π |
| **–°–µ—Ä–∏–∞–ª–∏–∑–∞—Ç–æ—Ä—ã** | `core/serializers/habits.py` | –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API |
| **URLs** | `core/urls.py` | –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è |

### –ö–ª—é—á–µ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è

- **Soft-delete**: –ü—Ä–∏–≤—ã—á–∫–∏ –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è —Ñ–∏–∑–∏—á–µ—Å–∫–∏, –∞ –ø–æ–º–µ—á–∞—é—Ç—Å—è `date_deleted`
- **–ï–¥–∏–Ω—ã–π endpoint –¥–ª—è CRUD**: –°–æ–∑–¥–∞–Ω–∏–µ, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ ‚Äî —á–µ—Ä–µ–∑ –æ–¥–∏–Ω `/habits/update/`
- **XP –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏**: –ü—Ä–∏ –∫–∞–∂–¥–æ–º –¥–µ–π—Å—Ç–≤–∏–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è `habit_total_xp`
- **–ê–º–Ω–∏—Å—Ç–∏—è**: –û—Ç–¥–µ–ª—å–Ω–∞—è —Å—É—â–Ω–æ—Å—Ç—å –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è "–ø—Ä–æ—â—ë–Ω–Ω—ã—Ö" –¥–Ω–µ–π

---

## –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö

### –°—Ö–µ–º–∞ —Å–≤—è–∑–µ–π

```
User (1) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ (N) Habit
               ‚îÇ              ‚îÇ
               ‚îÇ              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ (N) HabitCompletion
               ‚îÇ
               ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ (1) UserData (–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏–∏)
               ‚îÇ
               ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ (N) HabitAmnesty
```

### Habit ‚Äî –ü—Ä–∏–≤—ã—á–∫–∞

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| `id` | int | PK |
| `user` | FK ‚Üí User | –í–ª–∞–¥–µ–ª–µ—Ü |
| `name` | varchar(100) | –ù–∞–∑–≤–∞–Ω–∏–µ |
| `description` | text | –û–ø–∏—Å–∞–Ω–∏–µ (–¥–æ 500 —Å–∏–º–≤–æ–ª–æ–≤) |
| `icon` | varchar(50) | –ò–∫–æ–Ω–∫–∞ (`fire`, `strength`, `brain`...) |
| `xp_reward` | int | –ù–∞–≥—Ä–∞–¥–∞ –∑–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ (1-100) |
| `xp_penalty` | int | –®—Ç—Ä–∞—Ñ –∑–∞ –ø—Ä–æ–ø—É—Å–∫ (0-200) |
| `frequency_type` | enum | `daily`, `weekdays`, `weekends`, `custom` |
| `schedule_days` | JSON | –î–Ω–∏ –Ω–µ–¥–µ–ª–∏ `[0,1,2,3,4,5,6]` –≥–¥–µ 0=–ü–Ω |
| `order` | int | –ü–æ—Ä—è–¥–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ |
| `date_created` | datetime | –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è |
| `date_deleted` | datetime | Soft-delete –º–µ—Ç–∫–∞ |

**–ò–Ω–¥–µ–∫—Å—ã**: `(user, date_deleted)`, `(user, date_created)`

### HabitCompletion ‚Äî –õ–æ–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| `id` | int | PK |
| `habit` | FK ‚Üí Habit | –ü—Ä–∏–≤—ã—á–∫–∞ |
| `user` | FK ‚Üí User | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–¥–µ–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤) |
| `dt` | date | –î–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è |
| `status` | enum | `completed`, `missed`, `excused` |
| `note` | text | –ó–∞–º–µ—Ç–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| `excuse_reason` | text | –ü—Ä–∏—á–∏–Ω–∞ —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ–ø—É—Å–∫–∞ |
| `xp_change` | int | –ò–∑–º–µ–Ω–µ–Ω–∏–µ XP (+ –Ω–∞–≥—Ä–∞–¥–∞ –∏–ª–∏ - —à—Ç—Ä–∞—Ñ) |

**–£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å**: `(habit, dt)` ‚Äî –æ–¥–Ω–∞ –∑–∞–ø–∏—Å—å –Ω–∞ –ø—Ä–∏–≤—ã—á–∫—É –≤ –¥–µ–Ω—å

### HabitAmnesty ‚Äî –ê–º–Ω–∏—Å—Ç–∏—è

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| `id` | int | PK |
| `user` | FK ‚Üí User | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å |
| `dt` | date | –î–∞—Ç–∞ –∞–º–Ω–∏—Å—Ç–∏–∏ |
| `xp_returned` | int | –í–æ–∑–≤—Ä–∞—â—ë–Ω–Ω—ã–π XP |

**–£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å**: `(user, dt)` ‚Äî –æ–¥–Ω–∞ –∞–º–Ω–∏—Å—Ç–∏—è –Ω–∞ –¥–µ–Ω—å

### UserData ‚Äî –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ)

–î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –ø–æ–ª—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –º–æ–¥–µ–ª—å:

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| `habit_difficulty_mode` | enum | `soft`, `balanced`, `hardcore`, `custom` |
| `habit_penalty_multiplier` | decimal(3,2) | –ú–Ω–æ–∂–∏—Ç–µ–ª—å —à—Ç—Ä–∞—Ñ–∞ (0.00 - 1.00) |
| `habit_weekly_amnesty_count` | int | –õ–∏–º–∏—Ç –∞–º–Ω–∏—Å—Ç–∏–π –≤ –Ω–µ–¥–µ–ª—é (0-7) |
| `habit_total_xp` | int | –û–±—â–∏–π –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π XP |

---

## API Endpoints

### –û–±–∑–æ—Ä

| Endpoint | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ß–∞—Å—Ç–æ—Ç–∞ –≤—ã–∑–æ–≤–∞ |
|----------|------------|----------------|
| `habits/get/` | –°–ø–∏—Å–æ–∫ –ø—Ä–∏–≤—ã—á–µ–∫ | –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–∞–∑–¥–µ–ª–∞ |
| `habits/update/` | CRUD –ø—Ä–∏–≤—ã—á–µ–∫ | –ü–æ –¥–µ–π—Å—Ç–≤–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| `habits/tracker/get/` | –ù–µ–¥–µ–ª—å–Ω—ã–π —Ç—Ä–µ–∫–µ—Ä | –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ + –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ |
| `habits/completion/update/` | –û—Ç–º–µ—Ç–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è | –ö–∞–∂–¥—ã–π –∫–ª–∏–∫ –ø–æ –ø—Ä–∏–≤—ã—á–∫–µ |
| `habits/settings/get/` | –ù–∞—Å—Ç—Ä–æ–π–∫–∏ | –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ |
| `habits/settings/update/` | –ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ | –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ |
| `habits/amnesty/apply/` | –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∞–º–Ω–∏—Å—Ç–∏—é | –ü–æ –¥–µ–π—Å—Ç–≤–∏—é |
| `habits/amnesty/cancel/` | –û—Ç–º–µ–Ω–∏—Ç—å –∞–º–Ω–∏—Å—Ç–∏—é | –ü–æ –¥–µ–π—Å—Ç–≤–∏—é |
| `habits/analytics/get/` | –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ | –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏ |

---

### 1. GET Habits ‚Äî –°–ø–∏—Å–æ–∫ –ø—Ä–∏–≤—ã—á–µ–∫

**POST** `/api/app/habits/get/`

```json
// Request
{
  "include_deleted": false,
  "order_by": "date_created",
  "order_direction": "asc",
  "query_filter": "–∑–∞—Ä—è–¥–∫–∞",
  "page": 1
}

// Response
{
  "status": "ok",
  "data": {
    "total_active": 5,
    "total_deleted": 2,
    "total_filtered": 5,
    "total_pages": 1,
    "page": 1,
    "page_size": 20,
    "habits_data": [
      {
        "habit_id": 1,
        "name": "–ó–∞—Ä—è–¥–∫–∞ 10 –º–∏–Ω",
        "icon": "strength",
        "xp_reward": 10,
        "xp_penalty": 5,
        "frequency_type": "daily",
        "schedule_days": [0, 1, 2, 3, 4, 5, 6],
        "is_deleted": false
      }
    ]
  }
}
```

---

### 2. UPDATE Habits ‚Äî CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏

**POST** `/api/app/habits/update/`

**–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –ø—Ä–∏–≤—ã—á–∫–∏:**
```json
{
  "habits_data": [
    {
      "name": "–ú–µ–¥–∏—Ç–∞—Ü–∏—è",
      "icon": "meditation",
      "xp_reward": 15,
      "frequency_type": "daily"
    }
  ]
}
```

**–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π:**
```json
{
  "habits_data": [
    {
      "habit_id": 1,
      "xp_reward": 20
    }
  ]
}
```

**Soft-delete:**
```json
{
  "deleted_habit_ids": [1, 2]
}
```

**–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ:**
```json
{
  "restored_habit_ids": [1]
}
```

**–ü–æ–ª–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ:**
```json
{
  "permanent_delete_ids": [2]
}
```

> ‚ö†Ô∏è –ú–æ–∂–Ω–æ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å –≤ –æ–¥–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ

---

### 3. GET Tracker ‚Äî –ù–µ–¥–µ–ª—å–Ω—ã–π —Ç—Ä–µ–∫–µ—Ä

**POST** `/api/app/habits/tracker/get/`

```json
// Request (—Ç–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è)
{}

// Request (–∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –Ω–µ–¥–µ–ª—è)
{
  "date_from": "2025-01-06",
  "date_to": "2025-01-12"
}

// Response
{
  "status": "ok",
  "data": {
    "date_from": "2025-01-06",
    "date_to": "2025-01-12",
    "is_current_week": true,
    "is_past_week": false,
    "habits_tracker_data": [
      {
        "habit_id": 1,
        "name": "–ó–∞—Ä—è–¥–∫–∞",
        "icon": "strength",
        "xp_reward": 10,
        "days_data": [
          {
            "date": "2025-01-06",
            "weekday": 0,
            "status": "completed",
            "is_scheduled": true,
            "is_today": false
          },
          {
            "date": "2025-01-07",
            "weekday": 1,
            "status": "missed",
            "is_scheduled": true,
            "is_today": false
          }
        ]
      }
    ],
    "week_stats": {
      "total_scheduled": 35,
      "total_completed": 28,
      "completion_percent": 80,
      "xp_earned": 280,
      "xp_penalty": 35,
      "xp_net": 245
    },
    "today_stats": {
      "scheduled": 5,
      "completed": 3,
      "completion_percent": 60
    },
    "streak": 14,
    "amnesty": {
      "weekly_limit": 1,
      "used_this_week": 0,
      "remaining": 1,
      "amnestied_dates": []
    }
  }
}
```

**–°—Ç–∞—Ç—É—Å—ã –¥–Ω–µ–π:**

| Status | –ó–Ω–∞—á–µ–Ω–∏–µ | –í–∏–∑—É–∞–ª |
|--------|----------|--------|
| `completed` | –í—ã–ø–æ–ª–Ω–µ–Ω–æ | üü¢ –ó–µ–ª—ë–Ω—ã–π |
| `missed` | –ü—Ä–æ–ø—É—â–µ–Ω–æ | üî¥ –ö—Ä–∞—Å–Ω—ã–π |
| `excused` | –£–≤–∞–∂–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ–ø—É—Å–∫ | üü° –ñ—ë–ª—Ç—ã–π |
| `amnestied` | –ê–º–Ω–∏—Å—Ç–∏—è | ü©∑ –†–æ–∑–æ–≤—ã–π |
| `pending` | –°–µ–≥–æ–¥–Ω—è, –æ–∂–∏–¥–∞–µ—Ç | üü£ –§–∏–æ–ª–µ—Ç–æ–≤—ã–π |
| `future` | –ë—É–¥—É—â–∏–π –¥–µ–Ω—å | ‚ö™ –°–≤–µ—Ç–ª—ã–π |
| `not-scheduled` | –ù–µ –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏ | ‚¨ú –°–µ—Ä—ã–π |

---

### 4. UPDATE Completion ‚Äî –û—Ç–º–µ—Ç–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

**POST** `/api/app/habits/completion/update/`

**–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ (toggle):**
```json
{
  "habit_id": 1,
  "dt": "2025-01-08",
  "toggle_complete": true
}
```

**–Ø–≤–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–∞:**
```json
{
  "habit_id": 1,
  "dt": "2025-01-07",
  "status": "excused",
  "excuse_reason": "–ë—ã–ª –±–æ–ª–µ–Ω"
}
```

**Response:**
```json
{
  "status": "ok",
  "data": {
    "habit_id": 1,
    "date": "2025-01-08",
    "status": "completed",
    "xp_change": 10,
    "total_xp": 1250
  }
}
```

---

### 5. Settings ‚Äî –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏–∏

**GET** `/api/app/habits/settings/get/`

```json
{
  "status": "ok",
  "data": {
    "difficulty_mode": "balanced",
    "penalty_multiplier": 0.5,
    "weekly_amnesty_count": 1,
    "total_xp": 1250,
    "has_penalty_diary": false,
    "penalty_diary": 0,
    "mode_presets": {
      "soft": {"penalty_multiplier": 0, "weekly_amnesty_count": 0},
      "balanced": {"penalty_multiplier": 0.5, "weekly_amnesty_count": 1},
      "hardcore": {"penalty_multiplier": 1.0, "weekly_amnesty_count": 0}
    }
  }
}
```

**UPDATE** `/api/app/habits/settings/update/`

```json
// –í—ã–±–æ—Ä –ø—Ä–µ—Å–µ—Ç–∞
{
  "difficulty_mode": "hardcore"
}

// –ö–∞—Å—Ç–æ–º–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
{
  "difficulty_mode": "custom",
  "penalty_multiplier": 0.75,
  "weekly_amnesty_count": 2
}
```

---

### 6. Amnesty ‚Äî –ê–º–Ω–∏—Å—Ç–∏—è

**Apply** `/api/app/habits/amnesty/apply/`

```json
// Request
{
  "dt": "2025-01-07"
}

// Response
{
  "status": "ok",
  "data": {
    "date": "2025-01-07",
    "xp_returned": 25,
    "total_xp": 1275
  }
}
```

**Cancel** `/api/app/habits/amnesty/cancel/`

```json
// Request
{
  "dt": "2025-01-07"
}

// Response
{
  "status": "ok",
  "data": {
    "date": "2025-01-07",
    "xp_deducted": 25,
    "total_xp": 1250
  }
}
```

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∞–º–Ω–∏—Å—Ç–∏–∏:**
- –ù–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Ä–µ–∂–∏–º–µ `soft`
- –¢–æ–ª—å–∫–æ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
- –õ–∏–º–∏—Ç `weekly_amnesty_count` –≤ –Ω–µ–¥–µ–ª—é
- –ù–µ–ª—å–∑—è –ø—Ä–∏–º–µ–Ω–∏—Ç—å –¥–≤–∞–∂–¥—ã –∫ –æ–¥–Ω–æ–π –¥–∞—Ç–µ

---

### 7. Analytics ‚Äî –ê–Ω–∞–ª–∏—Ç–∏–∫–∞

**POST** `/api/app/habits/analytics/get/`

–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–º–ø–ª–µ–∫—Å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É:

```json
{
  "status": "ok",
  "data": {
    "completion": {
      "week_rate": 85,
      "month_rate": 78,
      "mini_chart_14": [...],
      "weekly_trend": [...],
      "best_week": {...},
      "worst_week": {...}
    },
    "calendar": {
      "heatmap_4_weeks": [...],
      "yearly_heatmap": [...],
      "monthly_stats": [...],
      "total_completions": 450,
      "active_days": 120
    },
    "achievements": {
      "unlocked": 8,
      "total": 19,
      "list": [
        {
          "id": "streak7",
          "icon": "üî•",
          "name": "–ù–µ–¥–µ–ª—è –æ–≥–Ω—è",
          "unlocked": true,
          "progress": 14,
          "target": 7
        }
      ]
    },
    "per_habit_stats": [...],
    "streak": 14,
    "total_xp": 1250
  }
}
```

---

## –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞

### –†–∞—Å—á—ë—Ç XP

```
–ü—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏:  +habit.xp_reward
–ü—Ä–∏ –ø—Ä–æ–ø—É—Å–∫–µ:    -habit.xp_penalty √ó settings.penalty_multiplier
–ü—Ä–∏ –∞–º–Ω–∏—Å—Ç–∏–∏:    –≤–æ–∑–≤—Ä–∞—Ç —à—Ç—Ä–∞—Ñ–∞ –∑–∞ –¥–µ–Ω—å
```

**–ú–Ω–æ–∂–∏—Ç–µ–ª–∏ –ø–æ —Ä–µ–∂–∏–º–∞–º:**

| –†–µ–∂–∏–º | penalty_multiplier | –ê–º–Ω–∏—Å—Ç–∏–π/–Ω–µ–¥–µ–ª—è |
|-------|-------------------|-----------------|
| soft | 0 | 0 |
| balanced | 0.5 | 1 |
| hardcore | 1.0 | 0 |
| custom | 0-1 | 0-7 |

### –†–∞—Å—á—ë—Ç Streak

Streak ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥ —Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º **–≤—Å–µ—Ö** –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–∏–≤—ã—á–µ–∫.

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
1. –ù–∞—á–∏–Ω–∞–µ–º —Å —Å–µ–≥–æ–¥–Ω—è, –∏–¥—ë–º –≤ –ø—Ä–æ—à–ª–æ–µ
2. –ï—Å–ª–∏ –¥–µ–Ω—å –±–µ–∑ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º (–Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç streak)
3. –ï—Å–ª–∏ –≤—Å–µ –ø—Ä–∏–≤—ã—á–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã ‚Äî streak++
4. –ï—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ ‚Äî —Å—Ç–æ–ø (–∫—Ä–æ–º–µ —Å–µ–≥–æ–¥–Ω—è)

### Soft-Delete

–ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø—Ä–∏–≤—ã—á–∫–∏:
1. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è `date_deleted = now()`
2. –ü—Ä–∏–≤—ã—á–∫–∞ –∏—Å—á–µ–∑–∞–µ—Ç –∏–∑ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞
3. –û—Å—Ç–∞—ë—Ç—Å—è –≤ –∏—Å—Ç–æ—Ä–∏–∏ (–ø—Ä–æ—à–ª—ã–µ –Ω–µ–¥–µ–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –µ—ë)
4. –ú–æ–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å (`date_deleted = NULL`)
5. –ü–æ–ª–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ ‚Äî —Ñ–∏–∑–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ + –≤—Å–µ completions

---

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º

### –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏

```
1. –û—Ç–∫—Ä—ã—Ç–∏–µ —Ä–∞–∑–¥–µ–ª–∞ "–ü—Ä–∏–≤—ã—á–∫–∏"
   ‚îî‚îÄ‚îÄ GET /habits/tracker/get/
       ‚Üí –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ —Ç—Ä–µ–∫–µ—Ä–∞

2. –ö–ª–∏–∫ –ø–æ –ø—Ä–∏–≤—ã—á–∫–µ (–æ—Ç–º–µ—Ç–∫–∞)
   ‚îî‚îÄ‚îÄ POST /habits/completion/update/ {toggle_complete: true}
       ‚Üí –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI + XP

3. –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –Ω–µ–¥–µ–ª—è–º
   ‚îî‚îÄ‚îÄ GET /habits/tracker/get/ {date_from, date_to}
       ‚Üí –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ —Ç—Ä–µ–∫–µ—Ä–∞

4. –û—Ç–∫—Ä—ã—Ç–∏–µ "–ê–Ω–∞–ª–∏—Ç–∏–∫–∏"
   ‚îî‚îÄ‚îÄ GET /habits/analytics/get/
       ‚Üí –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤ –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π

5. –û—Ç–∫—Ä—ã—Ç–∏–µ "–ù–∞—Å—Ç—Ä–æ–µ–∫"
   ‚îî‚îÄ‚îÄ GET /habits/settings/get/
       ‚Üí –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã
```

### –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

–î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ UX —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:

1. **Toggle completion**: –°—Ä–∞–∑—É –æ–±–Ω–æ–≤–∏—Ç—å UI, –ø–æ—Ç–æ–º –∂–¥–∞—Ç—å –æ—Ç–≤–µ—Ç
2. **XP –∏–∑–º–µ–Ω–µ–Ω–∏–µ**: –ü–æ–∫–∞–∑–∞—Ç—å –∞–Ω–∏–º–∞—Ü–∏—é "+10 XP" —Å—Ä–∞–∑—É
3. **–ü—Ä–∏ –æ—à–∏–±–∫–µ**: –û—Ç–∫–∞—Ç–∏—Ç—å UI –∏ –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ

### –ú–∞–ø–ø–∏–Ω–≥ frequency_type ‚Üí schedule_days

```javascript
const frequencyToSchedule = {
  'daily': [0, 1, 2, 3, 4, 5, 6],
  'weekdays': [0, 1, 2, 3, 4],      // –ü–Ω-–ü—Ç
  'weekends': [5, 6],               // –°–±-–í—Å
  'custom': /* –∏–∑ schedule_days */
}
```

### –¶–≤–µ—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ (—Ä–µ—Ñ–µ—Ä–µ–Ω—Å)

```css
.status-completed  { background: #22c55e; }  /* –ó–µ–ª—ë–Ω—ã–π */
.status-missed     { background: #ef4444; }  /* –ö—Ä–∞—Å–Ω—ã–π */
.status-excused    { background: #eab308; }  /* –ñ—ë–ª—Ç—ã–π */
.status-amnestied  { background: #ec4899; }  /* –†–æ–∑–æ–≤—ã–π */
.status-pending    { background: #7c3aed; }  /* –§–∏–æ–ª–µ—Ç–æ–≤—ã–π */
.status-future     { background: rgba(124,58,237,0.2); }
.status-not-scheduled { opacity: 0.4; }
```

---

## –ú–∏–≥—Ä–∞—Ü–∏–∏ –∏ –¥–µ–ø–ª–æ–π

### 1. –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π

```bash
python manage.py makemigrations core
```

–û–∂–∏–¥–∞–µ–º—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏:
- –°–æ–∑–¥–∞–Ω–∏–µ `Habit`
- –°–æ–∑–¥–∞–Ω–∏–µ `HabitCompletion`
- –°–æ–∑–¥–∞–Ω–∏–µ `HabitAmnesty`
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–µ–π –≤ `UserData`

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π

```bash
python manage.py sqlmigrate core <migration_name>
```

### 3. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ

```bash
python manage.py migrate
```

### 4. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ admin (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

```python
# core/admin.py
from core.models.user_data import Habit, HabitCompletion, HabitAmnesty

@admin.register(Habit)
class HabitAdmin(admin.ModelAdmin):
    list_display = ['id', 'user', 'name', 'xp_reward', 'date_created', 'date_deleted']
    list_filter = ['frequency_type', 'date_deleted']
    search_fields = ['name', 'user__email']

@admin.register(HabitCompletion)
class HabitCompletionAdmin(admin.ModelAdmin):
    list_display = ['id', 'habit', 'dt', 'status', 'xp_change']
    list_filter = ['status', 'dt']

@admin.register(HabitAmnesty)
class HabitAmnestyAdmin(admin.ModelAdmin):
    list_display = ['id', 'user', 'dt', 'xp_returned']
```

### 5. –ß–µ–∫–ª–∏—Å—Ç –¥–µ–ø–ª–æ—è

- [ ] –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã
- [ ] URLs –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ `core/urls.py`
- [ ] –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ç–æ—Ä—ã –≤ `core/serializers/habits.py`
- [ ] Views –≤ `core/views/drf/front_api_methods/habits.py`
- [ ] –ú–µ—Ç–æ–¥—ã –≤ `User` –º–æ–¥–µ–ª–∏
- [ ] –¢–µ—Å—Ç—ã –Ω–∞–ø–∏—Å–∞–Ω—ã
- [ ] Swagger/ReDoc –æ–±–Ω–æ–≤–ª—ë–Ω

---

## –ö–æ–¥—ã –æ—à–∏–±–æ–∫

| –ö–æ–¥ | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----|----------|
| `habit_not_access` | –ü—Ä–∏–≤—ã—á–∫–∞ –Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é |
| `habit_need_name_for_create` | –ù–µ —É–∫–∞–∑–∞–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ |
| `habit_not_found` | –ü—Ä–∏–≤—ã—á–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ |
| `cannot_edit_future` | –ù–µ–ª—å–∑—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –±—É–¥—É—â–∏–µ –¥–Ω–∏ |
| `bad_date_range_interval` | date_from > date_to |
| `amnesty_not_available_in_soft_mode` | –ê–º–Ω–∏—Å—Ç–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ soft |
| `amnesty_only_for_past` | –ê–º–Ω–∏—Å—Ç–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–æ—à–ª–æ–≥–æ |
| `amnesty_only_last_7_days` | –ê–º–Ω–∏—Å—Ç–∏—è —Ç–æ–ª—å–∫–æ –∑–∞ 7 –¥–Ω–µ–π |
| `amnesty_limit_reached` | –õ–∏–º–∏—Ç –∞–º–Ω–∏—Å—Ç–∏–π –∏—Å—á–µ—Ä–ø–∞–Ω |
| `amnesty_already_applied` | –ê–º–Ω–∏—Å—Ç–∏—è —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ |
| `amnesty_not_found` | –ê–º–Ω–∏—Å—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ |

---

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞

### –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ñ–ª–æ—É

```javascript
// 1. –ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–µ–∫–µ—Ä–∞
const tracker = await api.post('/habits/tracker/get/', {})

// 2. –û—Ç–º–µ—Ç–∫–∞ –ø—Ä–∏–≤—ã—á–∫–∏
const result = await api.post('/habits/completion/update/', {
  habit_id: 1,
  dt: '2025-01-08',
  toggle_complete: true
})

// 3. –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏
await api.post('/habits/update/', {
  habits_data: [{
    name: '–ù–æ–≤–∞—è –ø—Ä–∏–≤—ã—á–∫–∞',
    icon: 'fire',
    xp_reward: 10
  }]
})
```

### Store —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (–ø—Ä–∏–º–µ—Ä)

```javascript
habitsStore = {
  habits: [],           // –∏–∑ /habits/get/
  trackerData: null,    // –∏–∑ /habits/tracker/get/
  settings: null,       // –∏–∑ /habits/settings/get/
  analytics: null,      // –∏–∑ /habits/analytics/get/
  
  // Computed
  todayProgress: computed(() => ...),
  streak: computed(() => ...),
  totalXp: computed(() => ...)
}
```

---

*–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–∞ –Ω–∞: –î–µ–∫–∞–±—Ä—å 2025*