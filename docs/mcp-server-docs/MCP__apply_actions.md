# apply_actions

Фаза 2 двухфазного коммита: применить изменения после подтверждения пользователя.

## Назначение

**Критически важно:**
- Вызывай ТОЛЬКО после ЯВНОГО подтверждения пользователя!
- НИКОГДА не вызывай без предварительного preview_actions!
- НИКОГДА не вызывай если пользователь отказался или попросил изменить!

Инструмент реализует ВТОРУЮ (финальную) ФАЗУ двухфазного коммита:
1. Принимает preview_id от preview_actions
2. Валидирует preview (существует, не истёк, не использован)
3. Выполняет ВСЕ действия из preview атомарно (в одной транзакции)
4. Начисляет/списывает XP за выполненные действия
5. Помечает preview как "applied" (нельзя использовать повторно)
6. Возвращает результаты каждого действия

---

## Параметры

### preview_id (string, ОБЯЗАТЕЛЬНО)

UUID идентификатор preview для применения.

**Формат:** `xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx`

**Откуда получить:** Из ответа preview_actions:
```json
{
  "success": true,
  "preview_id": "5f02f604-1685-47dd-8f9c-535187d30d1c",
  ...
}
```

**Ограничения:**

| Ограничение | Значение | Что происходит при нарушении |
|-------------|----------|------------------------------|
| TTL (время жизни) | 5 минут (300 сек) | Ошибка "Preview expired" |
| Одноразовость | 1 использование | Ошибка "already applied" |
| Принадлежность | Только свой user | Ошибка "not found" |
| Статус | Только "pending" | Ошибка "already {status}" |

### user_confirmation (string, опционально)

Текст подтверждения пользователя. Сохраняется в логах для аудита.

**Примеры:**
- `"да"` — пользователь написал "да"
- `"Давай, применяй!"` — дословная цитата
- `"Inline button: Confirm"` — кнопка в Telegram

### idempotency_key (string, ОБЯЗАТЕЛЬНО)

UUID для защиты от дублей при ретраях сети.

**Формат:** `xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx`

**Как работает:**
- При первом вызове с `idempotency_key` — выполняет действия и кэширует результат
- При повторном вызове с тем же ключом — возвращает кэшированный результат БЕЗ повторного выполнения
- Ключ привязывается к preview и сохраняется в БД
- TTL кэширования: время жизни preview record (не истекает)

**Зачем обязателен:**
- Защита от дублей при ненадёжном сетевом соединении
- Безопасный ретрай когда ответ не дошёл
- Гарантия идемпотентности для критических операций (создание целей, начисление XP)

**Пример:**
```json
{
  "preview_id": "abc-123",
  "user_confirmation": "да",
  "idempotency_key": "550e8400-e29b-41d4-a716-446655440000"
}
```

**Важно:** Генерируй уникальный UUID для каждого нового apply_actions вызова.

---

## Когда вызывать

### ✅ ВЫЗЫВАЙ если пользователь ЯВНО подтвердил:

| Положительные ответы |
|---------------------|
| "да", "ага", "ок", "окей", "применить", "применяй" |
| "давай", "погнали", "подтверждаю", "согласен" |
| "всё верно", "делай", "+", "yes", "yep" |

### ❌ НЕ ВЫЗЫВАЙ если:

| Отрицательные ответы | Запросы на изменение | Неявные ответы |
|---------------------|---------------------|----------------|
| "нет", "не надо" | "измени название на..." | "наверное" |
| "отмена", "отменить" | "добавь ещё шаг" | "может быть" |
| "стоп", "подожди" | "поменяй категорию" | "хм...", "не знаю" |
| "не сейчас", "потом" | "давай переделаем" | (пустое сообщение) |

**Правило:** При сомнении — ПЕРЕСПРОСИ. Лучше уточнить, чем применить лишнее.

---

## Структура ответа

### Успешный ответ

```json
{
  "success": true,
  "results": [
    {
      "action": "goal.create",
      "client_action_id": "uuid-xxx",
      "success": true,
      "created_id": 789,
      "message": "Цель создана"
    },
    {
      "action": "step.complete",
      "client_action_id": "uuid-yyy",
      "success": true,
      "message": "Шаг отмечен выполненным"
    }
  ],
  "summary": {
    "total": 2,
    "successful": 2,
    "failed": 0
  },
  "message": "✓ Цель создана\n✓ Шаг отмечен выполненным"
}
```

### Частично успешный ответ

```json
{
  "success": false,
  "results": [
    {
      "action": "goal.create",
      "client_action_id": "uuid-xxx",
      "success": true,
      "created_id": 789,
      "message": "Цель создана"
    },
    {
      "action": "step.complete",
      "client_action_id": "uuid-yyy",
      "success": false,
      "error": "Step not found"
    }
  ],
  "summary": {
    "total": 2,
    "successful": 1,
    "failed": 1
  },
  "message": "✓ Цель создана\n✗ step.complete: Step not found"
}
```

### Ответ с ошибкой preview

```json
{
  "success": false,
  "error": "Preview not found or already used"
}
```

---

## XP начисление

При выполнении apply_actions автоматически начисляется/списывается XP:

| Действие | XP | Примечание |
|----------|-----|------------|
| goal.complete | +150 XP | Фиксировано |
| step.complete | +25 XP | Фиксировано |
| habit.mark_completed | +N XP | habit.xp_reward |
| habit.mark_missed | -N XP или 0 | Без excuse: -XP; с excuse: 0 |
| diary.create_entry | +10 XP | Фиксировано |
| goal.create, step.create, habit.create | 0 XP | XP за завершение |
| *.update, *.delete | 0 XP | Только изменение |

**Пример подсчёта:**
- Завершает 1 цель: +150 XP
- Завершает 3 шага: +75 XP (3 × 25)
- Отмечает 2 привычки (по 15 XP): +30 XP
- Пишет в дневник: +10 XP
- **ИТОГО:** +265 XP

---

## Статусы Preview

| Статус | Описание |
|--------|----------|
| `pending` | Создан, ожидает подтверждения. Можно вызвать apply_actions |
| `applied` | Успешно применён. Нельзя использовать повторно |
| `expired` | Истёк срок действия (TTL = 5 минут) |
| `cancelled` | Отменён через cancel_preview |

```
               preview_actions
                     │
                     ▼
            ┌─────────────────┐
            │ status: pending │
            │   TTL: 5 мин    │
            └────────┬────────┘
                     │
    ┌────────────────┼────────────────┐
    ▼                ▼                ▼
apply_actions   5 мин истекло   cancel_preview
    │                │                │
    ▼                ▼                ▼
 applied          expired         cancelled
```

---

## Атомарность выполнения

Все действия выполняются в ОДНОЙ транзакции БД:
- Если ВСЕ действия успешны → ВСЕ изменения сохраняются
- Если ХОТЯ БЫ ОДНО критическое действие провалилось → ВСЕ откатывается

**Пример:**
```
actions = [
  {action: "goal.create", params: {...}},    // 1. Успех → создана цель
  {action: "step.complete", params: {...}},  // 2. Ошибка → step not found
  {action: "habit.create", params: {...}}    // 3. Не выполняется
]

Результат: ВСЕ откатывается, цель НЕ создана, XP не начислен.
```

---

## Возможные ошибки

### Ошибки валидации preview

| Ошибка | Причина и решение |
|--------|-------------------|
| `preview_id is required` | Не передан preview_id |
| `idempotency_key is required` | Не передан idempotency_key (UUID) |
| `Preview not found or already used` | Preview не найден или принадлежит другому пользователю |
| `Preview expired` | Прошло более 5 минут. Создай новый preview_actions |
| `Preview already applied` | Этот preview уже был применён |
| `Preview already cancelled` | Preview был отменён |

### Ошибки выполнения действий

| Ошибка | Действия | Причина |
|--------|----------|---------|
| `title is required` | goal.create, step.create | Не указано обязательное поле |
| `name is required` | habit.create | Не указано обязательное поле |
| `At least one of what_done...` | diary.create_entry | Не указано ни одно поле дневника |
| `Goal not found` | goal.update, goal.complete | Сущность не существует |
| `Step not found` | step.update, step.complete | Сущность не существует |
| `Unknown action: {name}` | Любое | Неизвестное действие |

---

## Edge Cases

### Preview истёк (>5 минут)

```
User: "дай подумать" → 7 минут → User: "ок"
apply_actions → {success: false, error: "Preview expired..."}

Решение: "Предпросмотр устарел. Создаю новый..."
→ preview_actions с теми же actions → показать diff → спросить подтверждение
```

### Пользователь дважды говорит "да"

```
User: "да" → apply_actions → User: "да, точно!"
apply_actions → {success: false, error: "Preview already applied..."}

Решение: "Изменения уже были применены. Всё готово!"
```

### Сущность удалена между preview и apply

```
preview_actions({step.complete: step_id=123}) → User: "ок"
Но между этим кто-то удалил step 123

Решение: "Упс, шаг был удалён. Давай проверим актуальный список."
→ get_user_snapshot(include=["goals"])
```

### Пользователь частично согласен

```
AI: "Создам цель и 3 шага. Применить?"
User: "Цель создай, а шаги пока не надо"

Решение: НЕ вызывать apply_actions!
→ Создать НОВЫЙ preview_actions только с goal.create
```

---

## Рекомендации AI

1. **ВСЕГДА** жди ЯВНОГО подтверждения перед вызовом apply_actions

2. **НЕ ИНТЕРПРЕТИРУЙ** молчание как согласие — переспроси!

3. **Передавай** user_confirmation для аудита:
   ```
   apply_actions(preview_id="...", user_confirmation="Пользователь сказал: да")
   ```

4. **Обрабатывай** ошибки понятно для пользователя:
   - "Preview expired" → "Прошло много времени. Давай создам новый предпросмотр."
   - "Goal not found" → "Упс, эта цель уже удалена или не существует."

5. **При частичном успехе** — сообщи что получилось, что нет:
   "Цель создана, но шаг добавить не удалось — он уже был удалён."

6. **Подсчитывай и показывай XP:**
   "Готово! Ты заработал +175 XP за выполнение цели и шагов."

7. **Если preview истёк** — НЕ ПАНИКУЙ, просто создай новый

8. **При отказе пользователя** — preview автоматически истечёт через 5 минут

9. **После успешного apply_actions** можно использовать `created_id` для последующих операций

---

## Интеграция с другими tools

```
┌──────────────────────┐        ┌──────────────────────┐
│   get_user_snapshot  │───────▶│  preview_actions     │
│   (читает данные)    │        │  (готовит изменения) │
└──────────────────────┘        └──────────┬───────────┘
         │                                  │
         │ Используй для:                   │ Возвращает:
         │ • получить ID сущностей         │ • preview_id
         │ • узнать текущее состояние      │ • diff
         │                                  │
         │                                  ▼
         │                      ┌──────────────────────┐
         │                      │   apply_actions      │
         │                      │  (применяет)         │
         │                      └──────────┬───────────┘
         │                                  │
         └──────────────────────────────────│ Возвращает:
                                            │ • created_id
           Используй get_user_snapshot      │ • results
           после apply_actions для          │ • summary
           показа обновлённых данных        ▼
```

**Типичные цепочки:**

1. **Создание цели с шагами:**
   ```
   get_user_snapshot → preview_actions → [подтверждение] → apply_actions → get_user_snapshot
   ```

2. **Выполнение привычек за день:**
   ```
   get_user_snapshot(habits) → preview_actions → apply_actions → get_user_snapshot(xp)
   ```

---

## Связанные tools

- [get_user_snapshot](MCP__get_user_snapshot.md) — получение данных
- [preview_actions](MCP__preview_actions.md) — создание preview (фаза 1)
- [cancel_preview](MCP__cancel_preview.md) — отмена preview
